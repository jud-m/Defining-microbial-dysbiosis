---
title: "Defining microbial dysbiosis with machine learning in an African American cohort with self-reported hair loss"
author: "Judy-Malas, Sebastian Reczek, Jarrad Hampton-Marcell" 
date: "02/11/2025" #last update
output: 
  html_document: 
    toc: yes
    toc_float:
      collapsed: yes
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, message=F}

#library(devtools)
library(ggplot2)
#library(vegan)
#library(dplyr)
library(phyloseq)
library(randomForest)
#library(RColorBrewer)
library(tidyverse)
library(ggpubr)
#library(ggsci)
library(dysbiosisR)
#library(prettydoc)
#library(microViz)
#library(brew)
#library(pairwiseAdonis)
#library(ggvenn)
#library(extrafont)
library(NBZIMM)
#library(ZIBR)
library(reshape)
#library(nlme)

```

```{r load data}

ps_data <- readRDS("data/ps_data")


```

```{r cleanup and transformations}


#remove Caucasian subjects
ps_data  <- subset_samples(ps_data, Race_ID == "African.American")

#convert phylseq object into a dataframe 
ps_data.df <- psmelt(ps_data)

#cleanup Genus names
ps_data.df$Genus <- sub("g__", "", ps_data.df$Genus)

#cleanup Phyla names
ps_data.df$Phylum <- sub("p__", "", ps_data.df$Phylum)

#transform counts to relative abundances
ps_rel <- transform_sample_counts(ps_data, function(OTU) OTU/sum(OTU))

#convert the relative abundance data into a dataframe
ps_rel.df <- psmelt(ps_rel)

#cleanup Genus names
ps_rel.df$Genus <- sub("g__", "", ps_rel.df$Genus)



```

```{r plot options}

 theme_set(theme_bw()) #set the theme for all plots
 
```

## Explore taxonomy

```{r basic info}

#total number of sequences
sum(ps_data.df$Abundance)

```

```{r percentages of phyla}

#percentage of each phylum in descending order
percent_phyla <- ps_data.df %>% 
  group_by(Phylum) %>% 
  summarize(sum = sum(Abundance/1720130)*100) %>% 
  arrange(desc(sum))
percent_phyla 

#percentage of each genus in descending order
percent_genera <- ps_data.df %>% 
  group_by(Genus) %>% 
  summarize(sum = sum(Abundance/1720130)*100) %>% 
  arrange(desc(sum))
percent_genera


```



```{r Average relative abundance of major genera}

ps_data.df %>% 
  filter(Genus == c("Staphylococcus", "Corynebacterium", "Propionibacterium")) %>% 
  group_by(Genus, Area_Cond) %>% 
  summarize(average = sum(Abundance/1720130)*100)

ps_data.df %>% 
  filter(Genus == c("Staphylococcus", "Corynebacterium", "Propionibacterium")) %>% 
  group_by(Genus, Area_Cond) %>% 
  summarize(average = sum(Abundance/1720130)*100) %>% 
  ggplot(aes(Area_Cond, average, fill = Genus))+
  geom_bar(stat="identity")+
    coord_flip()+
    theme_bw()+
  scale_fill_viridis_d()+
  labs(x = "", y = "Average Relative Abundance (%)")


ggsave("figures/FigS1.pdf")


```



## Alpha diversity

```{r Generate alpha dversity data}

#generate alpha diversity metrics 
alpha <- microbiome::alpha(ps_data, index = "all")

#assign sample names to the new data 
alpha$X.SampleID <- rownames(alpha)

# extract sample data from the phyloseq object
df <- as(sample_data(ps_data), "data.frame")

# Merge Tables
alpha.table <- merge(alpha, df, by = "X.SampleID")

```

```{r diversity afflicted v. normal}

#Shannon diversity
 ggplot(alpha.table, aes(x = Area_Cond, y = diversity_shannon, fill = Area_Cond)) +
  geom_boxplot() +
    stat_compare_means() +
  labs(x = "Skin Site",
       y = "Shannon") +
    theme(axis.line.y = element_blank(),
          axis.ticks.y = element_blank(), 
          legend.title = element_blank())

#Number of OTUs
 ggplot(alpha.table, aes(x = Area_Cond, y = observed, fill = Area_Cond)) +
  geom_boxplot() +
    stat_compare_means() +
  labs(x = "Skin Site",
       y = "Oberserved OTUs") +
    theme(axis.line.y = element_blank(),
          axis.ticks.y = element_blank())
 
 #Calculate average number of OTUs per group
 alpha.table %>% 
   group_by(Area_Cond) %>% 
   summarise(mean(observed))

 
 
```


```{r Shannon v. Age regression}

#Shannon vs Age
ggplot(alpha.table,
       aes(x = Age, y = diversity_shannon, fill = Area_Cond, color = Area_Cond)) +
    geom_point(aes(color = Area_Cond)) +
    geom_smooth(method = "lm", fill = "gray", guide = "none") +
    stat_cor(aes(label = paste(..rr.label..)), guide = "none") +
    labs(x = "Age", y = "Shannon Diversity", title = "A") +
    scale_color_manual(values = c("red", "black"))+
    guides(color = guide_legend(override.aes = list(shape = 16, size = 3, fill = NA)))+
    theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
        axis.text.x = element_text(family = "Arial", size = 12),
        axis.text.y = element_text(family = "Arial", size = 12), 
        legend.text = element_text(family = "Arial", size = 10))

  
#ggsave("Pub_Figures/v2_Pub_Figures/Fig1a.jpeg", height = 4, width = 5)
#ggsave("Pub_Figures/PDF/Fig1a.pdf", height = 4, width = 5)






```

Check if alpha diversity is still different w/in age groups depending on site conditions

```{r ages by 20 years}

alpha.table %>% 
  mutate(Age_Cat2 = case_when(Age < 40 ~ "1) Less than 40", 
                              Age < 60 & Age > 39  ~ "2) 40 to 59", 
                              Age > 59 ~ "3) 60+")) %>% 
  ggplot(aes(x = Area_Cond, y = diversity_shannon)) +
  geom_boxplot(aes(color = Area_Cond), show.legend = F) +
  geom_point(aes(color = Area_Cond))+
  stat_compare_means(method="wilcox") +
  stat_cor()+
  scale_color_manual(values = c("red", "black"))+
  facet_wrap(~Age_Cat2)+
  guides(color = guide_legend(override.aes = list(shape = 16, size = 3, fill = NA)))+
  labs(x = " ", y = "Shannon Diversity", title = "B") +
      theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
        axis.text.x = element_text(family = "Arial", size = 10),
        axis.text.y = element_text(family = "Arial", size = 10), 
        legend.text = element_text(family = "Arial", size = 10), 
        legend.title = element_blank())
 
  


```

```{r diversity v. wash frequency and hairstyle}

alpha.table %>% 
  filter(Area_Cond == "Afflicted") %>% 
  ggplot(aes(x = Cleansing_Freq, y = diversity_shannon, fill = Cleansing_Freq)) +
  geom_boxplot() +
    stat_compare_means(label = "p.signif") +
  geom_point()+
  labs(x = " ",
       y = "Shannon Diversity") +
      theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
        axis.text.x = element_text(family = "Arial", size = 12),
        axis.text.y = element_text(family = "Arial", size = 12), 
        legend.text = element_text(family = "Arial", size = 10))

alpha.table %>% 
  filter(Area_Cond == "Afflicted") %>%
  mutate(Type = ifelse(Hair_Type == "Natural", "Natural",  "Other")) %>%
  filter(Type != is.na(Type)) %>% 
  ggplot(aes(x = Type, y = diversity_shannon, fill = Type)) +
  geom_boxplot() +
    stat_compare_means(label = "p.signif") +
  geom_point()+
  labs(x = " ",
       y = "Shannon Diversity") +
      theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
        axis.text.x = element_text(family = "Arial", size = 12),
        axis.text.y = element_text(family = "Arial", size = 12), 
        legend.text = element_text(family = "Arial", size = 10))

alpha.table %>% 
  filter(Area_Cond == "Afflicted") %>% 
  ggplot(aes(x = Hair_Type, y = diversity_shannon, fill = Hair_Type)) +
  geom_boxplot() +
    stat_compare_means(label = "p.signif") +
  geom_point()+
  labs(x = " ",
       y = "Shannon Diversity") +
      theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
        axis.text.x = element_text(family = "Arial", size = 12),
        axis.text.y = element_text(family = "Arial", size = 12), 
        legend.text = element_text(family = "Arial", size = 10))








```

## Dysbiosis Scores

```{r dysbiosis score}

#center log ratio (clr) transformation
clr <- microbiome::transform(ps_data, "clr")

#make a distance matrix
dist.matrix <- phyloseq::distance(clr, "euclidean") #euclidean distances of clr transformed data are Aitchison distances

#set Normal as the baseline
ref.samples <- sample_names(subset_samples(ps_data, 
                                           Area_Cond == "Normal")) 


#calculate dysbiosis scores
dysbiosis <- euclideanDistCentroids(ps_data,
                                      dist_mat = dist.matrix,
                                      use_squared = F,
                                      group_col = "Area_Cond",
                                      control_label = "Normal",
                                      case_label = "Afflicted")


# order the data 
dysbiosis$Area_Cond <- factor(dysbiosis$Area_Cond, 
                              levels = c("Normal", "Afflicted"))




```



```{r model performance}

#AOC plot to check sensitivity and specificity of the model
AUCplot <- pROC::roc(as.factor(dysbiosis$Area_Cond),
                   dysbiosis$CentroidDist_score,
                   #direction= ">",
                   plot=TRUE,
                   ci = TRUE,
                   auc.polygon=TRUE,
                   max.auc.polygon=TRUE,
                   print.auc=TRUE)

#calculate average dysbiosis score by group
dysbiosis %>% 
  group_by(Area_Cond) %>% 
  summarise(mean(CentroidDist_score))


#check to see if there is a signicant different in dysbiosis scores between groups 
ggplot(dysbiosis, aes(Area_Cond, CentroidDist_score)) +
  geom_boxplot()+
  geom_point()+
  stat_compare_means(method = "wilcox.test")+
  theme_bw()

#set a dysbiosis threshold
dysbiosis <- dysbiosis %>% 
  mutate(dysbiotic = case_when(CentroidDist_score > 0 ~ "Dysbiotic", 
                              CentroidDist_score < 0 ~ "Normobiosis" )) 


#check which hair sites got dysbiosis assignments
dysbiosis %>% 
  group_by(dysbiotic, Area_Cond) %>% 
  count(dysbiotic) %>% 
  arrange(desc(n))




```

```{r  dysbiosis wilcox tests w/ covariates}

ggplot(dysbiosis_4, aes(CentroidDist_score, Age))+
  geom_point()+
  geom_smooth(method="lm")+
  stat_cor() 


ggplot(dysbiosis_4, aes(CentroidDist_score, Stress_Scale))+
  geom_point()+
  geom_smooth(method="lm")+
  stat_cor() 

ggplot(dysbiosis_4, aes(CentroidDist_score, Dandruff_Scale))+
  geom_point()+
  geom_smooth(method="lm")+
  stat_cor() 

ggplot(dysbiosis_4, aes(Hair_Type, CentroidDist_score)) +
  geom_boxplot()+
  geom_point()+
  stat_compare_means(method = "wilcox.test")+
  theme_bw()

ggplot(dysbiosis_4, aes(Hair_Style_1, CentroidDist_score)) +
  geom_boxplot()+
  geom_point()+
  stat_compare_means()+
  theme_bw()

```

```{r Fig 2 Gradient plot}



volcano <- c("#003f5c", "#58508d","#bc5090","#ff6361", "#ffa600")

plotDysbiosisGradient(df=dysbiosis,
                                  score="CentroidDist_score",
                                  high_line = 0.0,
                                  group_var = "Area_Cond",
                                  group_colors=c("Normal" = "black", 
                                                 "Afflicted"= "brown3"),
                                  point_size = 2,
                                  bg_colors = rev(volcano),
                                  jitter_width = 0.1) +
  labs(y="Dysbiosis Score", subtitle = " ") +
  # adjust the x and y values to fit to plot
  ggplot2::annotate("text",  x = 0.65, y = .1, label = "Center", color="white")

ggsave("Figures/Fig2.pdf", height =6, width =5)



```




## Mixed Effects Model (MEM)



```{r prepdata}

ps_data@sam_data$Area_Cond <- as.factor(ps_data@sam_data$Area_Cond)

ps_data@sam_data$Area_Cond <- relevel(ps_data@sam_data$Area_Cond, ref = "Normal")

levels(ps_data@sam_data$Area_Cond)

```

```{r make a count matrix, results = "hide"}

# Aggregate Table by OTU
df.agg <- stats::aggregate(Abundance ~ OTU + X.SampleID, ps_data.df, FUN = sum)

# Make Blank Cells Unspecified
df.agg$OTU[df.agg$OTU == ""] <- "Unassigned"

# Manipulate Data Table to Short Version
df.agg.otus <- as.data.frame(reshape::cast(df.agg, X.SampleID ~ OTU, sum))

data <- df.agg.otus #preserve data before making a matrix

# Make SampleID Rownames and Remove Column
rownames(df.agg.otus) <- df.agg.otus$X.SampleID
df.agg.otus$X.SampleID <- NULL # to make a matrix

# Check Dimensions
dim(df.agg.otus)

```

```{r prepare variables for model}

### Create Variables for Model ###
# Sample Data
df.meta <- sample_data(ps_data)

Age <- df.meta$Age

Area_Cond <- df.meta$Area_Cond

# create data frame containing all the variables of interest
df.meta <- as_data_frame(df.meta)

df.meta.var <- df.meta %>%  dplyr::select(X.SampleID, Person_ID, Age, Age_Cat, Gender)

data.var <- left_join(data, df.meta, by = "X.SampleID" )



```


```{r run model 1}

mem <- NBZIMM::mms(y = df.agg.otus, fixed = ~ Area_Cond, data = data.var,  random = ~ 1 | Age,  min.p = 0.2, method = "nb")

```

```{r extract model data}

# Extract data
out = fixed(mem)$dist
out = out[out[,2]!="(Intercept)", ]
res = out[, 3:5]

# make a data frame
res.data <- as.data.frame(res)

#add OTU column to the data frame
res.data$OTU <- rownames(res.data)

#filter sigificant results
res.data <- res.data %>% 
  filter(pvalue <0.05)

#join results with all data
res.data.df <- left_join(res.data, ps_data.df, by = "OTU")

#clean up genus column
res.data.df$Genus <- sub("g__", "", res.data.df$Genus)

#number of OTUs that were more abundant in afflicted sites 
res.data %>% filter(Estimate > 0)

#number of unique genera that were differentially abundant
unique(res.data.df$Genus)

#count the Genus assignments of those OTUs
res.data.df %>% 
  distinct(OTU, .keep_all=TRUE) %>% 
  filter(Genus != is.na(Genus)) %>% 
  filter(Genus != "") %>% 
  group_by(Genus) %>% 
  count() %>% 
  arrange(desc(n))





```


```{r Make a nicer plot}

res.data.df %>% 
  filter(pvalue <0.05) %>% 
  filter(Genus != "Unassigned") %>% 
  filter(Genus != "") %>% 
  mutate(Genus1 = reorder(Genus, Estimate)) %>% 
  ggplot(aes(x = Genus1, y = Estimate)) +
    geom_point(alpha = 0.5) +
    #geom_jitter()+
    geom_errorbar(aes(ymin=Estimate-Std.Error,
                      ymax=Estimate+Std.Error), width=.1, alpha = 0.5) +
    coord_flip() +
    geom_hline(yintercept = 0, lty = 2) +
    theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
       axis.title.y= element_blank(),
        axis.text.x = element_text(family = "Arial", size = 10),
        axis.text.y = element_text(family = "Arial", size = 10))




## 100 signficant OTUs 

```

```{r keep only the OTUs with assigned species}


res.data.df %>% 
  filter(pvalue <0.05) %>% 
  filter(Species != "Unassigned") %>% #remove any OTUs that don't have assigned species
   filter(Species != "s__") %>% 
  mutate(Species1 = reorder(Species, Estimate)) %>% 
  ggplot(aes(x = Species1, y = Estimate, color = Genus)) +
    geom_point(alpha = 0.5)+
    #geom_jitter()+
    geom_errorbar(aes(ymin=Estimate-Std.Error,
                      ymax=Estimate+Std.Error), width=.1, alpha = 0.5) +
    coord_flip() +
    geom_hline(yintercept = 0, lty = 2) +
    theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
       axis.title.y= element_blank(),
        axis.text.x = element_text(family = "Arial", size = 10),
        axis.text.y = element_text(family = "Arial", size = 10))



```

## Random Forest with dysbiosis score

```{r set up for RF }

#check sample names in dysbiosis object 
dysbiosis_4$X.SampleID

#check sample names in sample data of alopecia object 
alopecia@sam_data$X.SampleID

#sample names should match 

#create dysbiotic character vector
dysbiosis_4 <- dysbiosis_4 %>% 
  mutate(dysbiotic = case_when(CentroidDist_score > 0 ~ "Dysbiotic", 
                              CentroidDist_score < 0 ~ "Normobiosis" )) 


#add dysbiosis score to the sample data
alopecia@sam_data$score <- dysbiosis_4$dysbiotic

alopecia@sam_data$numericScore <- dysbiosis_4$CentroidDist_score

#Make training dataset
predict <- t(otu_table(alopecia))

#Check dimensions
dim(predict)

#Create response variable

res <- as.factor(sample_data(alopecia)$score)

#res2 <- as.numeric(sample_data(alopecia)$numericScore) #for regression

#Combine predict variable and response variable into one dataframe
machine.data <- data.frame(res, predict)

#machine.data2 <- data.frame(res2, predict) #for regression

dim(machine.data)

```

* When you do a classification you always want an odd number of tree [don't want a 50% 50% decision]
* When you have 3 categories you don't want a multiple of 3, etc. 

```{r class RF}
# 
# set.seed(8)
# 
# class3<- randomForest(res ~ ., data = machine.data, ntree = 1001, importance = TRUE, nodesize = 1)
# 
# print(class3)
# 
# saveRDS(class3, "output/class3")

class3 <- readRDS("output/class3")

#saveRDS(class, "output/class") 
#class <- readRDS("output/class") # this is before setting use_squared = F in the dysbiosis score




```

```{r Confusion Matrix Plot for RF}

confusiondf <- as.data.frame(class3$confusion)

confusionfixed <- data.frame(Actual = c("Dysbiotic", "Dysbiotic", "Normobiosis", "Normobiosis"), Predicted = c("Dysbiotic", "Normobiosis", "Dysbiotic", "Normobiosis"), Count = c(confusiondf[1,1], confusiondf[1,2], confusiondf[2,1], confusiondf[2,2]), Freq = c(confusiondf[1,3], confusiondf[1,3], confusiondf[2,3], confusiondf[2,3]))

ggplot(confusionfixed, aes(x = Predicted, y = Actual, fill = Count)) +
  geom_tile()+
  geom_text(aes(label = Count), fontface="bold", color = "white") +
  geom_text(aes(label = Freq, vjust = 3), fontface="bold") +
  theme_bw() +
  theme(legend.position="none") +
  labs(x = "Predicted", y = "Actual")

```


Which taxa?

```{r class3 RF important taxa }

imp.taxa <- randomForest::importance(class3)

imp.taxa <- data.frame(predictors = rownames(imp.taxa), imp.taxa)

imp <- imp.taxa

# Order the predictor levels by importance
imp.sort <- arrange(imp, desc(MeanDecreaseAccuracy))
imp.sort$predictors <- factor(imp.sort$predictors, levels = imp.sort$predictors)

# Select the top 10 predictors
imp.10 <- imp.sort[1:100, ]

# Change Column name to say "OTUID" rather than "predictors"
colnames(imp.10)[which(names(imp.10) == "predictors")] <- "OTUID"

# Remove "X" from OTUID column
imp.10$OTUID <- gsub("X", "", paste(imp.10$OTUID))


# Make Taxa table a data frame
otu_df <- as.data.frame(tax_table(alopecia))

# Make OTU IDs (row names) into column
otu_df$OTUID <- rownames(otu_df)

# Merge Two data frames using matched column
imp10.merged <- merge(imp.10, otu_df, by = "OTUID")

RFtop100_Otus <- imp10.merged

number <- unique(RFtop100_Otus$Genus)



```


```{r Mean Decrease Accuracy plots for classification RF }
# palette <- c("lightpink", "cornflowerblue", "yellow2", "darkblue", "darkorange1", "deeppink", "darkviolet", "palegreen",  "springgreen4", "black", "goldenrod", "red", "blue", "#3DB7E9",  "#D55E00", "#F0E442",'#253494', "gray50", "purple", "orange", "lightgreen", "forestgreen")

imp10.merged$Genus <- sub("g__", "", imp10.merged$Genus)


imp10.merged %>% 
  group_by(Genus) %>% 
  summarise(sum = sum(MeanDecreaseAccuracy)) %>% 
  mutate(Genus = reorder(Genus, sum)) %>%
  filter(Genus != "") %>% 
  filter(Genus != is.na(Genus)) %>% 
ggplot(aes(x = Genus, y  = sum)) +
                                geom_bar(stat = "identity") +
                                #scale_color_manual(values= palette )+
                                #scale_fill_manual(values = palette)+
                                coord_flip() +
  theme(legend.position = "top", 
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(), 
       axis.title.y= element_blank(),
        axis.text.x = element_text(family = "Arial", size = 10),
        axis.text.y = element_text(family = "Arial", size = 10))+
                                labs(x = "Top Taxa for Classifying Normal vs Afflicted", 
                                  y = "Mean Decrease Accuracy (%)",
                                  fill = "") +
                                theme(
                                legend.text = element_text(face = "bold")
                                )+
  theme_bw()

#ggsave("Pub_Figures/Fig6.pdf", height = 5, width =6)
#ggsave("Pub_Figures/Fig6.jpeg", height = 5, width =6)

imp10.merged %>% 
  group_by(Genus) %>% 
  summarise(sum = sum(MeanDecreaseAccuracy)) %>% 
  filter(Genus != "g__") %>% 
  filter(Genus != is.na(Genus)) %>% 
  arrange(desc(sum))

```


## Compare predictive taxa


```{r v2 Extract the significant taxa from both tests}

#extract diff abundant taxa from the model 
res.data <- res.data %>% 
  filter(pvalue <0.05)

unique(res.data$OTU)


#RF top 100 OTUs
shared_sig.OTU <- intersect(res.data$OTU, RFtop100_Otus$OTU)

shared_sig.OTU #42 shared otus 

#keep only OTUs sig in both models
OTU.filt.alo.df <- alopecia.df %>% 
  filter(OTU %in% shared_sig.OTU) #2546 rows

#repeat for the relative abundance data frame 
OTU.filt.alo_rel.df <- ps_rel.df%>% 
  filter(OTU %in% shared_sig.OTU)

unique(OTU.filt.alo.df$OTU)


unique(OTU.filt.alo.df$Genus) #16 unique genera are shared


```


Can't figure out how to make the Venn diagram properly. Need to merge by OTUs assign genera to those OTUs while keep the "test" variable. I may just use the OTU% Venn diagram and then add on the Genera later
```{r Venn Diagram}


#add a variable to each one indicating which test they came from 

res.data$test <- "Mixed Effects Model" 

RFtop100_Otus$test <- "Random Forest Classifer"

RFtop100_Otus$OTU <- RFtop100_Otus$OTUID

shared <- full_join(res.data, RFtop100_Otus, by = c("OTU", "test"))


#keep only OTUs that are in both models
keep <- union(res.data$OTU, RFtop100_Otus$OTU)

shared <- shared %>% 
  filter(OTU %in% keep)


data_list <- split(shared$OTU, shared$test)


ggvenn(data_list, label_sep = "\n", fill_color = c("white", "white"), show_elements = F)


#ggsave("Pub_Figures/v2_Pub_Figures/Figure3A.jpeg")
# ggsave("Pub_Figures/v2_Pub_Figures/VennGENUS.jpeg", height = 10)

```




## Confirm differentially abundant species
```{r shared between random forest and model 1}

OTU.filt.alo.df$log10Abund <- log10( 1 + OTU.filt.alo.df$Abundance)

OTU.filt.alo.df %>% 
   filter(Genus != "") %>% 
  filter(Genus != "NA") %>% 
  ggplot(aes(Area_Cond, log10Abund)) +
  stat_compare_means()+
  facet_wrap(~Genus)



```
Taxa that are not sig different: 
- Actinobacillus
- Actinomyces
- Alloiococcus
- Dialister
- Granulicatella
- Neisseria
- Peptoniphilus
- Staphylococcus
- Veillonella


```{r remove taxa that are not sig different}

Genera <- sort(unique(OTU.filt.alo.df$Genus))

remove <- c("Alloiococcus", "Chryseobacterium",  "Granulicatella" ,"Neisseria", "Actinobacillus", "Actinomyces" ,"Dialister" ,  "Peptoniphilus" , "Staphylococcus","Veillonella" )
# 
Genera_sig <- Genera[!Genera %in% remove]
# 
# final_sig
# 
#keep only the important genera

OTU.filt.alo.df <- OTU.filt.alo.df %>% 
  filter(Genus %in% Genera_sig)

OTU.filt.alo_rel.df <- OTU.filt.alo_rel.df%>% 
  filter(Genus %in% Genera_sig)
# 
# unique(final_filt_alo.df$Genus)

sort(unique(OTU.filt.alo.df$Genus))

sort(unique(OTU.filt.alo.df$Genus))


```


Write a loop to test all the important OTUs and report the wilcox test values
Plus correct 


## plots for important taxa


```{r plot abundance of genera from the filtered OTUs}

#keep only OTUs sig in both models
OTU.filt.alo_rel.df <- ps_rel.df%>% 
  filter(OTU %in% shared_sig.OTU)

OTU.filt.alo_rel.df$Phylum <- sub("p__", "", OTU.filt.alo_rel.df$Phylum)

OTU.filt.alo_rel.df  %>% 
   filter(Genus %in% Genera_sig) %>% 
    mutate(Genus = reorder(Genus, Abundance)) %>% 
    ggplot(aes(Genus, Abundance, fill = Area_Cond))+
    geom_boxplot(alpha = 0.5)+
    scale_y_log10(breaks = scales::breaks_log(n = 10),     
                  labels = scales::number_format(accuracy = 0.0001))+
    #geom_point(aes(Genus, Abundance, color = Area_Cond), alpha = 0.5)+
    coord_flip()+
    theme_bw()+
    #scale_color_manual(values = c("red", "black"))+
    #stat_compare_means(method = "wilcox")+
    scale_fill_manual(values = c("black", "red"))+
  theme(legend.title = element_blank())
 
#ggsave("Pub_Figures/v2_Pub_Figures/figure3b.jpeg")


OTU.filt.alo_rel.df  %>% 
  filter(Genus %in% Genera_sig) %>% 
  group_by(Species) %>% 
  count()
  
 OTU.filt.alo_rel.df  %>% 
  filter(Genus %in% Genera_sig) %>% 
  group_by(Phylum, Genus) %>% 
  count()

 


```

```{r}

ps_rel.df %>% 
  filter(Genus == "Pseudomonas") %>% 
  ggplot(aes(Genus, Abundance, fill = Area_Cond))+
    geom_boxplot(alpha = 0.5)+
  scale_y_log10(breaks = scales::breaks_log(n = 10),     
                  labels = scales::number_format(accuracy = 0.0001))+
    #geom_point(aes(Genus, Abundance, color = Area_Cond), alpha = 0.5)+
    coord_flip()+
    theme_bw()+
    #scale_color_manual(values = c("red", "black"))+
    #stat_compare_means(method = "wilcox")+
    scale_fill_manual(values = c("black", "red"))

ps_rel.df$Species <- sub("s__", "", ps_rel.df$Species)

ps_rel.df %>% 
  filter(Species == c("epidermidis", "acnes")) %>% 
  ggplot(aes(Species, Abundance, fill = Area_Cond))+
    geom_boxplot(alpha = 0.5)+
  scale_y_log10(breaks = scales::breaks_log(n = 10), labels = scales::number_format(accuracy = 0.0001))+
  #scale_y_log10()+
    #geom_point(aes(Genus, Abundance, color = Area_Cond), alpha = 0.5)+
    coord_flip()+
    theme_bw()+
    #scale_color_manual(values = c("red", "black"))+
    #stat_compare_means(method = "wilcox")+
    scale_fill_manual(values = c("black", "red"))




```



## Taxa correlation with metadata

```{r stress scale}

alopecia.df$Stress_Scale <- as.numeric(alopecia.df$Stress_Scale)

ggplot(alopecia.df, aes(Area_Cond, Stress_Scale))+
  geom_boxplot()+
  stat_compare_means(method="kruskal.test", label = "p.signif")


```

```{r scalp density}


ggplot(alopecia.df, aes(Area_Cond, Density_Scale))+
  geom_boxplot()+
  stat_compare_means(method="kruskal.test", label = "p.signif")


```



